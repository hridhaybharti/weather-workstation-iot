<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Weather Workstation Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
:root {
  --primary-blue: #1e3a8a;
  --secondary-blue: #3b82f6;
  --light-blue: #dbeafe;
  --dark-blue: #1e40af;
  --accent-orange: #f59e0b;
  --accent-red: #ef4444;
  --accent-green: #10b981;
  --text-dark: #1f2937;
  --text-light: #6b7280;
  --card-bg: #ffffff;
  --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-gradient); color: var(--text-dark); min-height: 100vh; line-height: 1.6; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding:20px 30px; border-radius:20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.2);}
.header h1 { color: var(--primary-blue); font-size:2rem; font-weight:700; }
.controls { display:flex; gap:15px; align-items:center; }
.connection-status { display:flex; align-items:center; gap:8px; font-size:0.9rem; background: rgba(59,130,246,0.1); padding:8px 15px; border-radius:20px; color:var(--primary-blue); }
.status-dot { width:8px; height:8px; border-radius:50%; background-color:#ef4444; }
.status-dot.connected { background-color:#10b981; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.5;} }
#clock { background: var(--primary-blue); color:white; padding:8px 16px; border-radius:15px; font-weight:600; font-size:0.9rem; }
.toggle-btn { background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:15px; cursor:pointer; font-weight:600; transition:all .3s; }
.toggle-btn:hover { background:var(--dark-blue); transform:translateY(-2px); }
/* Dashboard */
.weather-dashboard { display:grid; grid-template-columns:1fr 2fr; gap:25px; margin-bottom:30px; }
@media (max-width:1024px) { .weather-dashboard { grid-template-columns:1fr; } }
.current-weather { background:var(--card-bg); border-radius:25px; padding:30px; box-shadow:0 10px 40px rgba(0,0,0,0.1); text-align:center; position:relative; overflow:hidden; }
.current-weather::before { content:''; position:absolute; top:0; left:0; right:0; height:6px; background:linear-gradient(90deg, var(--secondary-blue), var(--accent-orange)); }
.temperature-main { font-size:4.5rem; font-weight:300; color:var(--primary-blue); margin:20px 0 10px; line-height:1; }
.weather-condition { font-size:1.3rem; color:var(--text-light); margin-bottom:20px; font-weight:500; }
.date-location { color:var(--text-light); font-size:1rem; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #e5e7eb; }

.highlights-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:20px; margin-top:20px; }
.highlight-card { background:var(--light-blue); padding:20px; border-radius:15px; text-align:center; }
.highlight-card h3 { font-size:0.9rem; color:var(--text-light); margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; }
.highlight-value { font-size:1.8rem; font-weight:700; color:var(--primary-blue); margin-bottom:5px; }
.highlight-unit { font-size:0.8rem; color:var(--text-light); }

.right-panel { display:grid; grid-template-rows:auto 1fr; gap:25px; }

/* Sensor cards */
.sensor-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; }
@media (max-width:768px) { .sensor-cards { grid-template-columns:repeat(2,1fr); } }
.sensor-card { background:var(--card-bg); border-radius:20px; padding:25px; box-shadow:0 8px 30px rgba(0,0,0,0.08); text-align:center; transition:all .3s; border:1px solid rgba(255,255,255,0.2); position:relative; overflow:hidden; }
.sensor-card:hover { transform:translateY(-5px); box-shadow:0 15px 40px rgba(0,0,0,0.15); }
.sensor-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; background:var(--secondary-blue); transition:all .3s; }
.sensor-card.alert::before { background:var(--accent-red); }
.sensor-icon { font-size:2.5rem; margin-bottom:15px; opacity:0.8; }
.sensor-name { font-size:0.9rem; color:var(--text-light); margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; }
.sensor-value { font-size:2rem; font-weight:700; color:var(--primary-blue); margin-bottom:5px; transition:all .5s ease; }
.sensor-unit { font-size:0.8rem; color:var(--text-light); }
.sensor-status { position:absolute; top:15px; right:15px; font-size:0.7rem; padding:4px 8px; border-radius:10px; background:var(--accent-green); color:white; font-weight:600; }
.sensor-status.alert { background:var(--accent-red); animation: blink 1.5s infinite; }
@keyframes blink { 0%{opacity:1;}50%{opacity:0.2;}100%{opacity:1;} }

/* Chart */
.chart-container { background:var(--card-bg); border-radius:25px; padding:30px; box-shadow:0 10px 40px rgba(0,0,0,0.1); height:400px; }
.chart-container h2 { color:var(--primary-blue); margin-bottom:20px; font-size:1.5rem; font-weight:600; }
#chartCanvas { width:100% !important; height:320px !important; }

/* Footer */
.footer { text-align:center; margin-top:30px; color:white; font-size:0.9rem; opacity:0.8; }

.connection-retry { text-align:center; margin:20px 0; }
.retry-btn { background:var(--accent-orange); color:white; border:none; padding:12px 24px; border-radius:15px; cursor:pointer; font-weight:600; transition:all .3s; }
.retry-btn:hover { background:#d97706; transform:translateY(-2px); }

.progress-bar { width:100%; height:6px; background:#e5e7eb; border-radius:3px; margin-top:10px; overflow:hidden; }
.progress-fill { height:100%; background:linear-gradient(90deg, var(--accent-green), var(--secondary-blue)); border-radius:3px; transition: width .8s ease; }
.progress-fill.alert { background:linear-gradient(90deg, var(--accent-orange), var(--accent-red)); }

.loading { opacity:0.6; }
.no-data { color:var(--text-light) !important; font-style:italic; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üå§Ô∏è Weather Workstation</h1>
    <div class="controls">
      <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
      </div>
      <div id="clock"></div>
      <button class="toggle-btn" onclick="toggleMode()">üåô Dark Mode</button>
    </div>
  </div>

  <div class="connection-retry" id="connectionRetry" style="display:none;">
    <button class="retry-btn" onclick="initializeMQTT()">üîÑ Retry Connection</button>
  </div>

  <div class="weather-dashboard">
    <div class="current-weather">
      <div class="temperature-main" id="mainTemperature">--¬∞C</div>
      <div class="weather-condition" id="weatherCondition">Loading sensor data...</div>
      <div class="date-location" id="dateLocation"></div>
      <div class="highlights-grid">
        <div class="highlight-card">
          <h3>UV Index</h3>
          <div class="highlight-value" id="highlightUV">--</div>
          <div class="highlight-unit">index</div>
          <div class="progress-bar"><div class="progress-fill" id="uvProgress" style="width:0%"></div></div>
        </div>

        <div class="highlight-card">
          <h3>Humidity</h3>
          <div class="highlight-value" id="highlightHumidity">--%</div>
          <div class="progress-bar"><div class="progress-fill" id="humidityProgress" style="width:0%"></div></div>
        </div>

        <div class="highlight-card">
          <h3>Air Quality</h3>
          <div class="highlight-value" id="highlightAirQuality">--</div>
          <div class="highlight-unit">AQI</div>
          <div class="progress-bar"><div class="progress-fill" id="airQualityProgress" style="width:0%"></div></div>
        </div>

        <div class="highlight-card">
          <h3>Solar Radiation</h3>
          <div class="highlight-value" id="highlightSolar">--</div>
          <div class="highlight-unit">W/m¬≤</div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="sensor-cards" id="sensorCards"></div>

      <div class="chart-container">
        <h2>Sensor Trends</h2>
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>Weather Station Dashboard ¬© 2025</p>
  </div>
</div>

<script>
// ---------------- CONFIG ----------------
const CONFIG = {
  mqtt: {
    host: 'ws://12.10.12.180:8081',
    options: {
      clientId: 'weather_frontend_' + Math.random().toString(16).substr(2, 8),
      clean: true,
      connectTimeout: 5000,
      reconnectPeriod: 2000,
    }
  },
  sensors: [
    { name: "temperature_C", icon: "üå°Ô∏è", unit: "¬∞C", threshold: 30 },
    { name: "humidity_percent", icon: "üíß", unit: "%", threshold: 80 },
    { name: "co2_ppm", icon: "ü´Å", unit: "ppm", threshold: 1000 },
    { name: "oxygen_percent", icon: "üí®", unit: "%", threshold: 21 },
    { name: "uv_index", icon: "‚òÄÔ∏è", unit: "index", threshold: 8 },
    { name: "solar_wm2", icon: "üîÜ", unit: "W/m¬≤", threshold: 800 },
    { name: "air_quality_aqi", icon: "üçÉ", unit: "AQI", threshold: 200 },
    { name: "pressure_hpa", icon: "üå™Ô∏è", unit: "hPa", threshold: 1500 },
  ]
};

// ---------------- STATE ----------------
const state = {
  connected: false,
  mqttClient: null,
  lastData: {},
};

// ---------------- UI Setup ----------------
function createSensorCards() {
  const container = document.getElementById("sensorCards");
  CONFIG.sensors.forEach(s => {
    container.innerHTML += `
      <div class="sensor-card" id="card-${s.name}">
        <div class="sensor-icon">${s.icon}</div>
        <div class="sensor-name">${s.name.replace(/_/g, " ").toUpperCase()}</div>
        <div class="sensor-value" id="val-${s.name}">--</div>
        <div class="sensor-unit">${s.unit}</div>
        <div class="sensor-status" id="status-${s.name}">No data</div>
      </div>`;
  });
}

// ---------------- MQTT ----------------
function initializeMQTT() {
  console.log("Connecting to MQTT WebSocket‚Ä¶");

  state.mqttClient = mqtt.connect(CONFIG.mqtt.host, CONFIG.mqtt.options);

  state.mqttClient.on("connect", () => {
    console.log("MQTT Connected ‚úîÔ∏è");
    state.connected = true;
    document.getElementById("statusDot").classList.add("connected");
    document.getElementById("statusText").textContent = "Connected";

    state.mqttClient.subscribe("weather/workstation");
  });

  state.mqttClient.on("message", (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      console.log("MQTT Data:", data);
      updateDashboard(data);
    } catch (e) {
      console.error("Invalid JSON:", e);
    }
  });

  state.mqttClient.on("close", () => {
    console.log("MQTT Disconnected");
    document.getElementById("statusDot").classList.remove("connected");
    document.getElementById("statusText").textContent = "Disconnected";
  });
}

// ---------------- Dashboard Update ----------------
function updateDashboard(data) {
  state.lastData = data;

  CONFIG.sensors.forEach(s => {
    const v = data[s.name];
    const el = document.getElementById(`val-${s.name}`);
    const card = document.getElementById(`card-${s.name}`);
    const status = document.getElementById(`status-${s.name}`);

    if (v === undefined || v === null) return;

    el.textContent = parseFloat(v).toFixed(2);

    if (s.threshold && v > s.threshold) {
      card.classList.add("alert");
      status.textContent = "ALERT";
      status.classList.add("alert");
    } else {
      card.classList.remove("alert");
      status.textContent = "Normal";
      status.classList.remove("alert");
    }
  });

  // Main temperature
  if (data.temperature_C !== undefined) {
    document.getElementById("mainTemperature").textContent =
      data.temperature_C.toFixed(1) + "¬∞C";
  }

  // Update highlights
  document.getElementById("highlightHumidity").textContent =
    (data.humidity_percent || 0).toFixed(1) + "%";

  document.getElementById("highlightUV").textContent =
    (data.uv_index || 0).toFixed(1);

  document.getElementById("highlightAirQuality").textContent =
    (data.air_quality_aqi || 0).toFixed(1);

  document.getElementById("highlightSolar").textContent =
    (data.solar_wm2 || 0).toFixed(1);
}

// ---------------- Clock ----------------
function startClock() {
  setInterval(() => {
    document.getElementById("clock").textContent =
      new Date().toLocaleTimeString();
  }, 1000);
}

// ---------------- INIT ----------------
document.addEventListener("DOMContentLoaded", () => {
  createSensorCards();
  startClock();
  initializeMQTT();
});
</script>

</body>
</html>
